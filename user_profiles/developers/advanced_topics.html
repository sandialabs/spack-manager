

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Topics for Developers &mdash; Spack-Manager 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Snapshot Developer Workflow Example" href="snapshot_workflow.html" />
    <link rel="prev" title="Useful Commands for Development" href="useful_commands.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Spack-Manager
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../user_profiles.html">User Profiles</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../analysts/analysts.html">Analysts Documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="developers.html">Developer Documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="developer_spack_minimum.html">Developers: What you need to know about Spack</a></li>
<li class="toctree-l3"><a class="reference internal" href="developer_workflow.html">Quick-Start: Developer Workflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="useful_commands.html">Useful Commands for Development</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Advanced Topics for Developers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#handling-multiple-environments">Handling Multiple Environments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cleaning-up-old-environments">Cleaning Up Old Environments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modifying-specs-in-an-environment">Modifying Specs in an Environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging-spack-errors">Debugging Spack Errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#when-and-how-to-use-multiple-instances-of-spack-manager">When and How to Use Multiple Instances of Spack-Manager</a></li>
<li class="toctree-l4"><a class="reference internal" href="#strategies-for-conserving-disk-space">Strategies for Conserving Disk Space</a></li>
<li class="toctree-l4"><a class="reference internal" href="#constructing-and-utilizing-multiple-builds">Constructing and Utilizing Multiple builds</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="snapshot_workflow.html">Snapshot Developer Workflow Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../system_admins/system_admins.html">System Administrator Documentation</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../general/general.html">General Information</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../additional_commands/additional_commands.html">Additional Commands</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Spack-Manager</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../user_profiles.html">User Profiles</a></li>
          <li class="breadcrumb-item"><a href="developers.html">Developer Documentation</a></li>
      <li class="breadcrumb-item active">Advanced Topics for Developers</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/user_profiles/developers/advanced_topics.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="advanced-topics-for-developers">
<h1>Advanced Topics for Developers<a class="headerlink" href="#advanced-topics-for-developers" title="Link to this heading"></a></h1>
<p>This section is designed to go over some of the tips and tricks for developers
that will help you improve your workflow and handle some more nuanced scenarios.</p>
<section id="handling-multiple-environments">
<h2>Handling Multiple Environments<a class="headerlink" href="#handling-multiple-environments" title="Link to this heading"></a></h2>
<p>Spack-Manager is designed to support multiple environments from a single Spack
instance.
This allows common libraries to be reused between installations.
Where you place the environments is entirely up to you.
There is a default location <code class="docutils literal notranslate"><span class="pre">$SPACK_MANAGER/environments</span></code> where the environments
will be created if you pass the <code class="docutils literal notranslate"><span class="pre">--name</span></code> or <code class="docutils literal notranslate"><span class="pre">-n</span></code> flag into one of the environment
creation commands.
Using the <code class="docutils literal notranslate"><span class="pre">--directory</span></code> or <code class="docutils literal notranslate"><span class="pre">-d</span></code> argument will create the environment at the local
path you specify.
Omitting either of these arguments will lead to the environment being created in
the current working directory.</p>
<p>In terms of when to create an environment, our recommendation is that an environment
be created for each unique concept you are working on, and once that concept is finalized
you uninstall the software and/or delete the environment.</p>
</section>
<section id="cleaning-up-old-environments">
<h2>Cleaning Up Old Environments<a class="headerlink" href="#cleaning-up-old-environments" title="Link to this heading"></a></h2>
<p>If an environment is stale and hasn’t been used in a while, our recommendation
is to create a new environment using it’s <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> and then just delete the
old environment.</p>
<p>An example of how to do this is:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">quick-create -d [location of new env] -y [old environment]/spack.yaml</span>
<span class="go">spack -e [old environment] uninstall --all</span>
<span class="go">rm -rf [old environment]</span>
</pre></div>
</div>
<blockquote>
<div><p><strong>TIP:</strong> Using <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">-e</span> <span class="pre">[env</span> <span class="pre">location]</span></code> allows you to run commands in that environment
without activating it in your shell.</p>
</div></blockquote>
<p>If you truly wish to revise the environment then it is a good idea to try and reconcretize
before making changes to the environment.  <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">concretize</span> <span class="pre">-f</span></code>.</p>
</section>
<section id="modifying-specs-in-an-environment">
<h2>Modifying Specs in an Environment<a class="headerlink" href="#modifying-specs-in-an-environment" title="Link to this heading"></a></h2>
<p>Once an environment is active in your shell it can still be modified.
The definition of the environment is in the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> file and modifying this
will modify the environment.
So to add a variant, such as making the build a debug build, simply open the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code>
in your environment’s directory and add <code class="docutils literal notranslate"><span class="pre">build_type=Debug</span></code> to the spec for the package
you want to be built in debug mode.</p>
<blockquote>
<div><p><strong>TIP:</strong> Spack has a built in command for automatically opening the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> file in a
text editor for you. It is <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">config</span> <span class="pre">edit</span></code>. The default editor is Vim, but you can set it to be anything you want simply by setting the <code class="docutils literal notranslate"><span class="pre">EDITOR</span></code> environment variable i.e. <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">EDITOR=emacs</span></code>.</p>
</div></blockquote>
<p>A more archaic way to do this from the command line would be to remove the spec
and then add it back with the edits that you want.</p>
<p>For example say you have <code class="docutils literal notranslate"><span class="pre">amr-wind&#64;master+openfast+hypre</span></code> as the spec in your environment.
You could run</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">spack rm amr-wind@master</span>
<span class="go">spack add amr-wind@master+openfast+hypre build_type=Debug</span>
</pre></div>
</div>
<p>if you really don’t want to open the yaml file.
This is discouraged though because it involves more typing and is prone to more errors.
All users are encouraged to become comfortable reading and editing the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> file.
The ones generated by Spack-Manager are quite small and only contain information pertinent
to you as an end user.</p>
</section>
<section id="debugging-spack-errors">
<h2>Debugging Spack Errors<a class="headerlink" href="#debugging-spack-errors" title="Link to this heading"></a></h2>
<p>It is inevitable that you will encounter some error from Spack while using Spack-Manager.
Spack-Manager is a dynamic tool that tries to stay up-to-date with Spack’s new features.
Sometimes we catch bugs and sometimes there are incompatibilities or inconsistencies
in the state of your Spack installation.</p>
<p>We suggest the following steps for how to handle an error from Spack:</p>
<ol class="arabic simple">
<li><p>If you just updated Spack-Manager make sure the Spack submodule is up-to-date: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">update</span></code></p></li>
<li><p>Read the error message again and see if it makes sense.  Many of the error messages are quite good.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">sm-clean</span></code>.  This is a heavy clean up command for Spack-Manager that we’ve created based on the errors we’ve seen in the past.</p></li>
<li><p>Run your Spack command with the <code class="docutils literal notranslate"><span class="pre">-d</span></code> flag (debug) i.e. <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">-d</span> <span class="pre">install</span></code> and see if that gives you any more insight</p></li>
<li><p>Reach out for help on slack, github issues or email.</p></li>
</ol>
</section>
<section id="when-and-how-to-use-multiple-instances-of-spack-manager">
<h2>When and How to Use Multiple Instances of Spack-Manager<a class="headerlink" href="#when-and-how-to-use-multiple-instances-of-spack-manager" title="Link to this heading"></a></h2>
<p>Sometimes it is useful to have multiple instances of Spack-Manager.
Some examples of when it would be a good idea to do this:</p>
<ul class="simple">
<li><p>You have multiple machines on a shared filesystem and they are conflicting, or one is problematic while the other is stable.</p></li>
<li><p>You want to archive production environments/builds and separate them from your software development work.</p></li>
<li><p>You are developing features for Spack or Spack-Manager and want to keep it separate from the rest of your work.</p></li>
</ul>
<p>The key concept here is that there is something stable and something more dynamic.
It is useful to blow away everything in dynamic software development and start from scratch periodically.</p>
<p>Spack-Manager has been designed to be self-contained and to not create or use dependencies from other Spack
instances as much as possible.
The key thing is you don’t want to mix Spack instances in the same shell.
So to use different Spack-Manager instances you just need to make sure that the <code class="docutils literal notranslate"><span class="pre">SPACK_MANAGER</span></code> environment variable
is set to the right instance and that you don’t switch things up in the same shell.</p>
<p>An example of how this can be done in a <code class="docutils literal notranslate"><span class="pre">bashrc</span></code> is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load dynamic spack-manager for software development</span>
<span class="k">function</span><span class="w"> </span>development-spack-manager<span class="o">(){</span>
<span class="w">  </span><span class="nb">export</span><span class="w"> </span><span class="nv">SPACK_MANAGER</span><span class="o">=</span>/path/to/my/dynamic/spack-manager
<span class="w">  </span><span class="nb">source</span><span class="w"> </span><span class="si">${</span><span class="nv">SPACK_MANAGER</span><span class="si">}</span>/start.sh
<span class="w">  </span>spack-start
<span class="o">}</span>

<span class="c1"># Load stable builds</span>
<span class="k">function</span><span class="w"> </span>production-spack-manager<span class="o">(){</span>
<span class="w">  </span><span class="nb">export</span><span class="w"> </span><span class="nv">SPACK_MANAGER</span><span class="o">=</span>/path/to/my/production/spack-manager
<span class="w">  </span><span class="nb">source</span><span class="w"> </span><span class="si">${</span><span class="nv">SPACK_MANAGER</span><span class="si">}</span>/start.sh
<span class="w">  </span>spack-start
<span class="o">}</span>
</pre></div>
</div>
<p>In this example the different Spack-Manager instances can be loaded in a new shell by calling separate functions.</p>
</section>
<section id="strategies-for-conserving-disk-space">
<h2>Strategies for Conserving Disk Space<a class="headerlink" href="#strategies-for-conserving-disk-space" title="Link to this heading"></a></h2>
<p>If Spack is not periodically pruned it can become a storage hog.
When doing software development Spack will create and preserve the build directory for develop specs,
and then it will install the binaries in the common Spack install tree.</p>
<p>To prune your local build directories you can simply run <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">spack*</span></code> inside a build directory.
This will remove all the files and directories Spack created but not modify your source code.
It is essentially just removing the CMake build directory and all of Spack’s logs.
If you are frequently modifying specs for your environment (switch from Release to Debug) then you
will notice several build directories <code class="docutils literal notranslate"><span class="pre">spack-build-[hash]</span></code>.
Preserving these allows for incremental builds, and deleting them will cause you to rebuild the entire software product.
So there is a trade off between waiting on builds and storage space.</p>
<p>To handle the issue of install trees we’ve added the <code class="docutils literal notranslate"><span class="pre">--local-source</span></code> or <code class="docutils literal notranslate"><span class="pre">-l</span></code> flag to the environment creation commands.
This will make it so all the binaries are installed local to the environment in a directory named <code class="docutils literal notranslate"><span class="pre">opt/</span></code>.
Now when you delete the environment you will also delete all the install binaries and you don’t need to worry about them piling up in the
main Spack install tree.</p>
<p>However, if you only use this option you will end up rebuilding all the binaries in every environment.
Using <code class="docutils literal notranslate"><span class="pre">--local-source</span></code> means that the environment can’t doesn’t see any of the other environments and you will need to create a link between them.
To link to your main Spack database create the <code class="docutils literal notranslate"><span class="pre">$SPACK_MANAGER/configs/user/upstreams.yaml</span></code> file and put the following inside of it:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">upstreams</span><span class="p">:</span>
<span class="w"> </span><span class="nt">root_spack</span><span class="p">:</span>
<span class="w">   </span><span class="nt">install_tree</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$spack/opt/spack</span>
</pre></div>
</div>
<p>Any files added to the <code class="docutils literal notranslate"><span class="pre">$SPACK_MANAGER/configs/user</span></code> directory will automatically be added to the environments you create going forward.
This allows users to set configurations like upstreams or personal preferences without needing to have them get pushed to the main repo.
The addition above makes it so any <code class="docutils literal notranslate"><span class="pre">--local-source</span></code> environment you create can reuse binaries from your main install tree.</p>
<p>So to setup a very space conservative Spack-Manager repo you should do the following:</p>
<ol class="arabic simple">
<li><p>Create a base environment and install the software you want to use without using <code class="docutils literal notranslate"><span class="pre">--local-source</span></code></p></li>
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">upstreams.yaml</span></code> file as specified above.</p></li>
<li><p>Create all development environments with the <code class="docutils literal notranslate"><span class="pre">--local-source</span></code> or <code class="docutils literal notranslate"><span class="pre">-l</span></code> flag.</p></li>
</ol>
<p>Now whenever you want to clean things up just delete your development environment directory and all the space from that specific build will be removed.
Doing this is a bit tedious and the new base environments will need to be periodically created for new compilers and flags, or the existing ones will need to be updated.</p>
</section>
<section id="constructing-and-utilizing-multiple-builds">
<h2>Constructing and Utilizing Multiple builds<a class="headerlink" href="#constructing-and-utilizing-multiple-builds" title="Link to this heading"></a></h2>
<p>One of the nice features about using Spack is the build environments you setup can have arbitrary complexity.
A nice feature for this is to setup your development environment to perform multiple builds that you may need
from the same source such as a <code class="docutils literal notranslate"><span class="pre">+cuda</span></code> and <code class="docutils literal notranslate"><span class="pre">~cuda</span></code> build, or <code class="docutils literal notranslate"><span class="pre">Release</span></code> and <code class="docutils literal notranslate"><span class="pre">Debug</span></code> builds.</p>
<p>To do this you need to edit the <code class="docutils literal notranslate"><span class="pre">spack.yaml</span></code> file so that the <code class="docutils literal notranslate"><span class="pre">concretizer:unify</span></code> parameter is set to <code class="docutils literal notranslate"><span class="pre">false</span></code>.
<code class="docutils literal notranslate"><span class="pre">Unify</span></code> tells the concretizer that all the software has to concretize into a single graph.
We turn on unification by default in Spack-Manager to serve as a guard-rail for users and to simply syntax for setting up environments.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spack</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># having the two specs</span>
<span class="w">  </span><span class="nt">specs</span><span class="p">:</span><span class="w"> </span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nalu-wind@master+hypre+cuda</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nalu-wind@master+hypre~cuda</span>
<span class="w">  </span><span class="nt">view</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">concretizer</span><span class="p">:</span>
<span class="w">    </span><span class="nt">unify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span><span class="c1"># this is defaulted to true</span>
<span class="w">  </span><span class="nt">include</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">include.yaml</span>
<span class="w">  </span><span class="nt">develop</span><span class="p">:</span>
<span class="w">    </span><span class="nt">nalu-wind</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># this develop spec matches both the root specs and so the source code will be used for both</span>
<span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nalu-wind@master</span>
</pre></div>
</div>
<p>You may not want to rebuild both instances of the code every time you make a change.
However, you can do <code class="docutils literal notranslate"><span class="pre">build-env-dive</span> <span class="pre">nalu-wind~cuda</span></code> if you want to develop the code on a non-cuda environment for the faster link times.
When using <code class="docutils literal notranslate"><span class="pre">build-env-dive</span></code> you can simply call <code class="docutils literal notranslate"><span class="pre">make</span></code>, <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code>, run the tests, etc from inside the build directory.
When you want to test the cuda build you can exit the build-env and rebuild the Cuda case.
An example of this workflow is illustrated below.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>Setup<span class="w"> </span>the<span class="w"> </span>environment
<span class="go">quick-create -d two-build-one-env -s nalu-wind+cuda nalu-wind~cuda</span>
<span class="go">spack manager develop nalu-wind@master</span>
<span class="go">spack config add conncretizer:unify:false # a way to edit the spack.yaml configs from the command line</span>
<span class="go">spack install </span>
<span class="gp"># </span>dive<span class="w"> </span>into<span class="w"> </span>the<span class="w"> </span>non-cuda<span class="w"> </span>build<span class="w"> </span>environment
<span class="go">build-env-dive nalu-wind~cuda</span>
<span class="gp"># </span>make<span class="w"> </span>some<span class="w"> </span>code<span class="w"> </span>changes
<span class="go">[...]</span>
<span class="gp"># </span>run<span class="w"> </span>the<span class="w"> </span>unit-tests<span class="w"> </span>and<span class="w"> </span>interate
<span class="go">make -j8 &amp;&amp; ./unittestX</span>
<span class="gp"># </span>jump<span class="w"> </span>out<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>build0-env<span class="w"> </span>
<span class="go">exit</span>
<span class="gp"># </span>now<span class="w"> </span>rebuild<span class="w"> </span>everything<span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>changes
<span class="go">spack install</span>
<span class="gp"># </span>check<span class="w"> </span>the<span class="w"> </span>cuda<span class="w"> </span>tests
<span class="go">build-env-dive nalu-wind+cuda</span>
<span class="go">ctest -R unit -VV</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="useful_commands.html" class="btn btn-neutral float-left" title="Useful Commands for Development" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="snapshot_workflow.html" class="btn btn-neutral float-right" title="Snapshot Developer Workflow Example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>